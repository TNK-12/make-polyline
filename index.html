<script>
let map = L.map('map');
let marker = null;
let path = [];
let polyline = L.polyline([], {
  color: 'red',
  weight: 4
}).addTo(map);

navigator.geolocation.watchPosition(
  (pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const current = [lat, lng];

    // 初回
    if (!marker) {
      map.setView(current, 17);
      marker = L.marker(current).addTo(map);

      path.push(current);
      polyline.setLatLngs(path);
      return; // ← 初回はここで終了してOK
    }

    // 2回目以降
    const last = path[path.length - 1];
    const dist = map.distance(last, current);

    // 5m以上動いたら更新
    if (dist >= 5) {
      path.push(current);
      polyline.setLatLngs(path);
    }

    marker.setLatLng(current);
    map.panTo(current);
  },
  (err) => {
    alert("位置情報エラー: " + err.message);
  },
  {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  }
);
</script>
